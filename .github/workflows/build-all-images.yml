name: Build All Base Images

"on":
  push:
    tags:
      - "*"
  schedule:
    - cron: "0 2 * * 2"
  workflow_dispatch: {}

concurrency:
  group: build-all
  cancel-in-progress: true

jobs:
  dispatch:
    name: Dispatch base builds
    runs-on: ubuntu-latest
    env:
      REF: ${{ github.ref }}
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: "Test: Set up Python"
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.x"

      - name: "Test: Remove Python yq and keep using Go yq"
        run: |
          python -m pip uninstall -y yq

      - name: "Test: Install lint deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: "Test: Run linters (yamllint, ruff, pymarkdown)"
        run: |
          yamllint .
          ruff check .
          pymarkdown --config .pymarkdown.json scan .

      - name: "Test: Validate config and bases with schemas"
        run: |
          check-jsonschema \
            --schemafile doc/validation/config.schema.json \
            config.yaml
          check-jsonschema \
            --schemafile doc/validation/base.schema.json \
            bases/*/base.yaml

      - name: Dispatch per-base builds
        run: |
          set -euo pipefail
          for dir in bases/*; do
            BASE_ALIAS="$(basename "${dir}")"
            echo "Dispatching ${BASE_ALIAS} for ${REF}"
            gh workflow run build-image.yml --ref "${REF}" -f base="${BASE_ALIAS}"
          done
