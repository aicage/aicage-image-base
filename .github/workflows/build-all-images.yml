name: Build All Base Images (Latest Release Ref)
run-name: Dispatch build-all-images-worker.yml at latest release tag

"on":
  schedule:
    - cron: "0 2 * * 2"
  workflow_dispatch: {}

permissions:
  actions: write
  contents: read

jobs:

  latest-release-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest release tag
        id: latest
        run: |
          set -euo pipefail
          AICAGE_VERSION="$(
            curl \
              -fsSL \
              --retry 8 \
              --retry-all-errors \
              --retry-delay 2 \
              --max-time 300 \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest" \
            | jq -r '.tag_name'
          )"
          if [[ -z "${AICAGE_VERSION}" ]]; then
            echo "Latest release tag is empty" >&2
            exit 1
          fi
          {
            echo "AICAGE_VERSION=${AICAGE_VERSION}"
          } >> "$GITHUB_OUTPUT"
          echo "Latest release tag: ${AICAGE_VERSION}"

      - name: Dispatch build-all-images worker at release ref
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.latest.outputs.AICAGE_VERSION }}
        run: |
          set -euo pipefail
          gh workflow run build-all-images-worker.yml --ref "${TAG}"  --repo "${GITHUB_REPOSITORY}"
