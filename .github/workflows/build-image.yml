name: Build Base Image (Template)
run-name: Build base image (${{ inputs.base }})

"on":
  workflow_call:
    inputs:
      base:
        description: Base alias to build (matches bases/<alias>)
        required: true
        type: string
  workflow_dispatch:
    inputs:
      base:
        description: Base alias to build (matches bases/<alias>)
        required: true
        type: string

concurrency:
  group: build-${{ inputs.base }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write
  id-token: write

jobs:

  load_config:
    name: Load config file, set variables
    runs-on: ubuntu-latest
    env:
      BASE_ALIAS: ${{ inputs.base }}
      ROOT_DIR: ${{ github.workspace }}
      AICAGE_VERSION: ${{ github.ref_name }}
    outputs:
      IMAGE_NAME: ${{ steps.config.outputs.IMAGE_NAME }}
      MANIFEST_VERSION_TAG: ${{ steps.config.outputs.MANIFEST_VERSION_TAG }}
      MANIFEST_LATEST_TAG: ${{ steps.config.outputs.MANIFEST_LATEST_TAG }}
      MANIFEST_TEST_TAG: ${{ steps.config.outputs.MANIFEST_TEST_TAG }}
      ROOT_IMAGE: ${{ steps.config.outputs.ROOT_IMAGE }}
      BASE_IMAGE_DISTRO: ${{ steps.config.outputs.BASE_IMAGE_DISTRO }}
      BASE_IMAGE_DESCRIPTION: ${{ steps.config.outputs.BASE_IMAGE_DESCRIPTION }}
      OS_INSTALLER: ${{ steps.config.outputs.OS_INSTALLER }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: "Test: Set up Python"
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.x"

      - name: "Test: Remove Python yq and keep using Go yq"
        run: |
          python -m pip uninstall -y yq

      - name: "Test: Install lint deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: "Test: Run linters (yamllint, ruff, pymarkdown)"
        run: |
          yamllint .
          ruff check .
          pymarkdown --config .pymarkdown.json scan .

      - name: "Test: Validate config and base with schemas"
        run: |
          check-jsonschema \
            --schemafile doc/validation/config.schema.json \
            config.yaml
          check-jsonschema \
            --schemafile doc/validation/base.schema.json \
            "bases/${BASE_ALIAS}/base.yaml"

      - name: "Test: Validate base alias"
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -d "bases/${BASE_ALIAS}" ]]; then
            echo "Base '${BASE_ALIAS}' not found under bases/" >&2
            exit 1
          fi

      - name: Load config file
        id: config
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          IMAGE_NAME="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}"
          MANIFEST_VERSION_TAG="${IMAGE_NAME}:${BASE_ALIAS}-${AICAGE_VERSION}"
          MANIFEST_LATEST_TAG="${IMAGE_NAME}:${BASE_ALIAS}"
          MANIFEST_TEST_TAG="${MANIFEST_VERSION_TAG}-test"
          {
            echo "IMAGE_NAME=${IMAGE_NAME}"
            echo "MANIFEST_VERSION_TAG=${MANIFEST_VERSION_TAG}"
            echo "MANIFEST_LATEST_TAG=${MANIFEST_LATEST_TAG}"
            echo "MANIFEST_TEST_TAG=${MANIFEST_TEST_TAG}"
            echo "ROOT_IMAGE=$(get_base_field "${BASE_ALIAS}" root_image)"
            echo "BASE_IMAGE_DISTRO=$(get_base_field "${BASE_ALIAS}" base_image_distro)"
            echo "BASE_IMAGE_DESCRIPTION=$(get_base_field "${BASE_ALIAS}" base_image_description)"
            echo "OS_INSTALLER=$(get_base_field "${BASE_ALIAS}" os_installer)"
          } >> "$GITHUB_OUTPUT"

  build:
    name: "${{ matrix.arch }}: Build, test, and publish ${{ inputs.base }}"
    runs-on: ${{ matrix.runner }}
    needs: load_config
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.platform }}
      ARCH_SUFFIX: ${{ matrix.arch }}
      BASE_ALIAS: ${{ inputs.base }}
      IMAGE_NAME: ${{ needs.load_config.outputs.IMAGE_NAME }}
      MANIFEST_VERSION_TAG: ${{ needs.load_config.outputs.MANIFEST_VERSION_TAG }}
      MANIFEST_LATEST_TAG: ${{ needs.load_config.outputs.MANIFEST_LATEST_TAG }}
      BASE_IMAGE_DISTRO: ${{ needs.load_config.outputs.BASE_IMAGE_DISTRO }}
      BASE_IMAGE_DESCRIPTION: ${{ needs.load_config.outputs.BASE_IMAGE_DESCRIPTION }}
    outputs:
      AICAGE_IMAGE_DIGEST_amd64: ${{ steps.out.outputs.AICAGE_IMAGE_DIGEST_amd64 }}
      AICAGE_IMAGE_DIGEST_arm64: ${{ steps.out.outputs.AICAGE_IMAGE_DIGEST_arm64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set config
        id: config
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_VERSION_TAG="${MANIFEST_VERSION_TAG}-${ARCH_SUFFIX}"
          IMAGE_LATEST_TAG="${MANIFEST_LATEST_TAG}-${ARCH_SUFFIX}"
          IMAGE_TEST_TAG="${IMAGE_VERSION_TAG}-test"
          {
            echo "IMAGE_VERSION_TAG=${IMAGE_VERSION_TAG}"
            echo "IMAGE_LATEST_TAG=${IMAGE_LATEST_TAG}"
            echo "IMAGE_TEST_TAG=${IMAGE_TEST_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "IMAGE_VERSION_TAG=${IMAGE_VERSION_TAG}"
            echo "IMAGE_LATEST_TAG=${IMAGE_LATEST_TAG}"
            echo "IMAGE_TEST_TAG=${IMAGE_TEST_TAG}"
          } >> "$GITHUB_ENV"

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build test image tag
        id: build_image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          provenance: true
          build-args: |
            ROOT_IMAGE=${{ needs.load_config.outputs.ROOT_IMAGE }}
            OS_INSTALLER=${{ needs.load_config.outputs.OS_INSTALLER }}
          tags: |
            ${{ steps.config.outputs.IMAGE_TEST_TAG }}
          labels: |
            org.opencontainers.image.description=Base image for aicage (${{ env.BASE_ALIAS }})
            org.aicage.base=${{ env.BASE_ALIAS }}
            org.aicage.base.distro=${{ env.BASE_IMAGE_DISTRO }}
            org.aicage.base.description=${{ env.BASE_IMAGE_DESCRIPTION }}

      - name: "Test: Pull base image for local tests"
        run: |
          set -euo pipefail
          docker pull "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}"

      - name: "Test: Setup BATS testing framework"
        uses: mig4/setup-bats@v1.2.0

      - name: "Test: Run smoke suites on base image"
        run: |
          set -euo pipefail
          scripts/test.sh \
            --image "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}" \
            --base "${BASE_ALIAS}"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Sign image with cosign
        run: |
          set -euo pipefail
          cosign sign --yes \
            "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}"

      - name: Verify image signature
        run: |
          set -euo pipefail
          cosign verify \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity-regexp \
              "^https://github.com/${GITHUB_REPOSITORY}/.github/workflows/.*@refs/.*/.*$" \
            "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}"

      - name: "Publish: Set architecture-specific image tag"
        run: |
          set -euo pipefail
          # Promote the already-built & provenanced artifact by digest (no rebuild)
          docker buildx imagetools create \
            --tag "${IMAGE_VERSION_TAG}" \
            --tag "${IMAGE_LATEST_TAG}" \
            "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}"

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Delete test image tag
        run: |
          set -euo pipefail
          oras manifest delete "${IMAGE_TEST_TAG}"

      - id: out
        name: Output variables
        run: |
          set -euo pipefail
          echo "AICAGE_IMAGE_DIGEST_${{ matrix.arch }}=${{ steps.build_image.outputs.digest }}" >> "$GITHUB_OUTPUT"
          echo "AICAGE_IMAGE_DIGEST=${{ steps.build_image.outputs.digest }}" >> "$GITHUB_OUTPUT"

  manifest:
    name: Publish multi-arch manifest ${{ inputs.base }}
    runs-on: ubuntu-latest
    needs: [load_config, build]
    env:
      MANIFEST_VERSION_TAG: ${{ needs.load_config.outputs.MANIFEST_VERSION_TAG }}
      MANIFEST_LATEST_TAG: ${{ needs.load_config.outputs.MANIFEST_LATEST_TAG }}
      MANIFEST_TEST_TAG: ${{ needs.load_config.outputs.MANIFEST_TEST_TAG }}
      AICAGE_IMAGE_DIGEST_amd64: ${{ needs.build.outputs.AICAGE_IMAGE_DIGEST_amd64 }}
      AICAGE_IMAGE_DIGEST_arm64: ${{ needs.build.outputs.AICAGE_IMAGE_DIGEST_arm64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Publish: Create and push multi-arch manifest"
        id: build_manifest
        run: |
          set -euo pipefail
          docker buildx imagetools create \
              --tag "${MANIFEST_TEST_TAG}" \
              "${AICAGE_IMAGE_DIGEST_amd64}" \
              "${AICAGE_IMAGE_DIGEST_arm64}"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: "Publish: Sign multi-arch manifest"
        run: |
          set -euo pipefail
          cosign sign --yes \
            "${MANIFEST_TEST_TAG}"

      - name: "Test: Verify multi-arch manifest signature"
        run: |
          set -euo pipefail
          cosign verify \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity-regexp \
              "^https://github.com/${GITHUB_REPOSITORY}/.github/workflows/.*@refs/.*/.*$" \
            "${MANIFEST_TEST_TAG}"

      - name: "Publish: Set tags for multi-arch manifest"
        run: |
          set -euo pipefail
          # Promote the already-built & provenanced artifact by digest (no rebuild)
          docker buildx imagetools create \
            --tag "${MANIFEST_VERSION_TAG}" \
            --tag "${MANIFEST_LATEST_TAG}" \
            "${MANIFEST_TEST_TAG}"

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Delete test image tag
        run: |
          set -euo pipefail
          oras manifest delete "${MANIFEST_TEST_TAG}"
