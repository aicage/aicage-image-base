name: Build Base Image (Template)

run-name: Build base image (${{ inputs.base }})

"on":
  workflow_call:
    inputs:
      base:
        description: Base alias to build (matches bases/<alias>)
        required: true
        type: string
  workflow_dispatch:
    inputs:
      base:
        description: Base alias to build (matches bases/<alias>)
        required: true
        type: string

concurrency:
  group: build-${{ inputs.base }}
  cancel-in-progress: true

jobs:

  load_config:
    name: Load config file, set variables
    runs-on: ubuntu-latest
    env:
      BASE_ALIAS: ${{ inputs.base }}
      AICAGE_VERSION: ${{ github.ref_name }}
      ROOT_DIR: ${{ github.workspace }}
    outputs:
      AICAGE_IMAGE_REGISTRY: ${{ steps.config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_BASE_REPOSITORY: ${{ steps.config.outputs.AICAGE_IMAGE_BASE_REPOSITORY }}
      ROOT_IMAGE: ${{ steps.config.outputs.ROOT_IMAGE }}
      BASE_IMAGE_DISTRO: ${{ steps.config.outputs.BASE_IMAGE_DISTRO }}
      BASE_IMAGE_DESCRIPTION: ${{ steps.config.outputs.BASE_IMAGE_DESCRIPTION }}
      OS_INSTALLER: ${{ steps.config.outputs.OS_INSTALLER }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: "Test: Set up Python"
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.x"

      - name: "Test: Remove Python yq and keep using Go yq"
        run: |
          python -m pip uninstall -y yq

      - name: "Test: Install lint deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: "Test: Run linters (yamllint, ruff, pymarkdown)"
        run: |
          yamllint .
          ruff check .
          pymarkdown --config .pymarkdown.json scan .

      - name: "Test: Validate config and base with schemas"
        run: |
          check-jsonschema \
            --schemafile doc/validation/config.schema.json \
            config.yaml
          check-jsonschema \
            --schemafile doc/validation/base.schema.json \
            "bases/${BASE_ALIAS}/base.yaml"

      - name: Validate base alias
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -d "bases/${BASE_ALIAS}" ]]; then
            echo "Base '${BASE_ALIAS}' not found under bases/" >&2
            exit 1
          fi

      - name: Load config file
        id: config
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          {
            echo "AICAGE_IMAGE_REGISTRY=${AICAGE_IMAGE_REGISTRY}"
            echo "AICAGE_IMAGE_BASE_REPOSITORY=${AICAGE_IMAGE_BASE_REPOSITORY}"
            echo "ROOT_IMAGE=$(get_base_field "${BASE_ALIAS}" root_image)"
            echo "BASE_IMAGE_DISTRO=$(get_base_field "${BASE_ALIAS}" base_image_distro)"
            echo "BASE_IMAGE_DESCRIPTION=$(get_base_field "${BASE_ALIAS}" base_image_description)"
            echo "OS_INSTALLER=$(get_base_field "${BASE_ALIAS}" os_installer)"
          } >> "$GITHUB_OUTPUT"

  build:
    name: "${{ matrix.arch }}: Build, test, and publish ${{ inputs.base }}"
    runs-on: ${{ matrix.runner }}
    needs: load_config
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.platform }}
      ARCH_SUFFIX: ${{ matrix.arch }}
      BASE_ALIAS: ${{ inputs.base }}
      BASE_IMAGE_DISTRO: ${{ needs.load_config.outputs.BASE_IMAGE_DISTRO }}
      BASE_IMAGE_DESCRIPTION: ${{ needs.load_config.outputs.BASE_IMAGE_DESCRIPTION }}
      AICAGE_IMAGE_REGISTRY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_BASE_REPOSITORY: ${{ needs.load_config.outputs.AICAGE_IMAGE_BASE_REPOSITORY }}
      AICAGE_VERSION: ${{ github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set config
        id: config
        shell: bash
        run: |
          set -euo pipefail
          VERSION_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-${ARCH_SUFFIX}-${AICAGE_VERSION}"
          LATEST_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-${ARCH_SUFFIX}-latest"
          {
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "LATEST_TAG=${LATEST_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "LATEST_TAG=${LATEST_TAG}"
          } >> "$GITHUB_ENV"

      - name: Build (local only, leaves image on runner)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          build-args: |
            ROOT_IMAGE=${{ needs.load_config.outputs.ROOT_IMAGE }}
            OS_INSTALLER=${{ needs.load_config.outputs.OS_INSTALLER }}
          tags: |
            ${{ steps.config.outputs.VERSION_TAG }}
            ${{ steps.config.outputs.LATEST_TAG }}
          labels: |
            org.opencontainers.image.description=Base image for aicage (${{ env.BASE_ALIAS }})
            org.aicage.base=${{ env.BASE_ALIAS }}
            org.aicage.base.distro=${{ env.BASE_IMAGE_DISTRO }}
            org.aicage.base.description=${{ env.BASE_IMAGE_DESCRIPTION }}

      - name: "Test: Setup BATS testing framework"
        uses: mig4/setup-bats@v1.2.0

      - name: "Test: Run smoke suite on base image"
        run: |
          set -euo pipefail
          scripts/test.sh --image "${VERSION_TAG}" --base "${BASE_ALIAS}"

      - name: "Publish: Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Publish: Push architecture-specific image"
        run: |
          set -euo pipefail
          docker push "${VERSION_TAG}"
          docker push "${LATEST_TAG}"

  manifest:
    name: Publish multi-arch manifest ${{ inputs.base }}
    runs-on: ubuntu-latest
    needs: [load_config, build]
    env:
      BASE_ALIAS: ${{ inputs.base }}
      AICAGE_IMAGE_REGISTRY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_BASE_REPOSITORY: ${{ needs.load_config.outputs.AICAGE_IMAGE_BASE_REPOSITORY }}
      AICAGE_VERSION: ${{ github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Create and push multi-arch manifest"
        run: |
          set -euo pipefail
          VERSION_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-${AICAGE_VERSION}"
          LATEST_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-latest"

          docker buildx imagetools create \
            --tag "${VERSION_TAG}" \
            --tag "${LATEST_TAG}" \
            "${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-amd64-${AICAGE_VERSION}" \
            "${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-arm64-${AICAGE_VERSION}"

          for tag in "${VERSION_TAG}" "${LATEST_TAG}"; do
            echo "Inspect tag '${tag}':"
            docker buildx imagetools inspect "${tag}"
          done
