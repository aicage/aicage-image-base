name: Build Base Image (Template)

run-name: Build base image (${{ inputs.base }})

"on":
  workflow_call:
    inputs:
      base:
        description: Base alias to build (matches bases/<alias>)
        required: true
        type: string
  workflow_dispatch:
    inputs:
      base:
        description: Base alias to build (matches bases/<alias>)
        required: true
        type: string

concurrency:
  group: build-${{ inputs.base }}
  cancel-in-progress: true

jobs:

  load_config:
    name: Load config file, set variables
    runs-on: ubuntu-latest
    env:
      BASE_ALIAS: ${{ inputs.base }}
      AICAGE_VERSION: ${{ github.ref_name }}
      ROOT_DIR: ${{ github.workspace }}
    outputs:
      AICAGE_IMAGE_REGISTRY: ${{ steps.config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_BASE_REPOSITORY: ${{ steps.config.outputs.AICAGE_IMAGE_BASE_REPOSITORY }}
      BASE_IMAGE: ${{ steps.config.outputs.BASE_IMAGE }}
      BASE_IMAGE_DISTRO: ${{ steps.config.outputs.BASE_IMAGE_DISTRO }}
      BASE_IMAGE_DESCRIPTION: ${{ steps.config.outputs.BASE_IMAGE_DESCRIPTION }}
      OS_INSTALLER: ${{ steps.config.outputs.OS_INSTALLER }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate base alias
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -d "bases/${BASE_ALIAS}" ]]; then
            echo "Base '${BASE_ALIAS}' not found under bases/" >&2
            exit 1
          fi

      - name: Load config file
        id: config
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          {
            echo "AICAGE_IMAGE_REGISTRY=${AICAGE_IMAGE_REGISTRY}"
            echo "AICAGE_IMAGE_BASE_REPOSITORY=${AICAGE_IMAGE_BASE_REPOSITORY}"
            echo "BASE_IMAGE=$(get_base_field "${BASE_ALIAS}" base_image)"
            echo "BASE_IMAGE_DISTRO=$(get_base_field "${BASE_ALIAS}" base_image_distro)"
            echo "BASE_IMAGE_DESCRIPTION=$(get_base_field "${BASE_ALIAS}" base_image_description)"
            echo "OS_INSTALLER=$(get_base_field "${BASE_ALIAS}" os_installer)"
          } >> "$GITHUB_OUTPUT"

  build_amd64:
    name: "amd64: Build, test, and publish ${{ inputs.base }}"
    runs-on: ubuntu-latest
    needs: load_config
    env:
      PLATFORM: linux/amd64
      ARCH_SUFFIX: amd64
      BASE_ALIAS: ${{ inputs.base }}
      BASE_IMAGE_DISTRO: ${{ needs.load_config.outputs.BASE_IMAGE_DISTRO }}
      BASE_IMAGE_DESCRIPTION: ${{ needs.load_config.outputs.BASE_IMAGE_DESCRIPTION }}
      AICAGE_IMAGE_REGISTRY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_BASE_REPOSITORY: ${{ needs.load_config.outputs.AICAGE_IMAGE_BASE_REPOSITORY }}
      AICAGE_VERSION: ${{ github.ref_name }}
    outputs:
      VERSION_TAG: ${{ steps.config.outputs.VERSION_TAG }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set config
        id: config
        shell: bash
        run: |
          set -euo pipefail
          VERSION_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-${ARCH_SUFFIX}-${AICAGE_VERSION}"
          LATEST_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-${ARCH_SUFFIX}-latest"
          {
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "LATEST_TAG=${LATEST_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "LATEST_TAG=${LATEST_TAG}"
          } >> "$GITHUB_ENV"

      - name: Build (local only, leaves image on runner)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          build-args: |
            BASE_IMAGE=${{ needs.load_config.outputs.BASE_IMAGE }}
            OS_INSTALLER=${{ needs.load_config.outputs.OS_INSTALLER }}
          tags: |
            ${{ steps.config.outputs.VERSION_TAG }}
            ${{ steps.config.outputs.LATEST_TAG }}
          labels: |
            org.opencontainers.image.description=Base image for aicage (${{ env.BASE_ALIAS }})
            org.aicage.base=${{ env.BASE_ALIAS }}
            org.aicage.base.distro=${{ env.BASE_IMAGE_DISTRO }}
            org.aicage.base.description=${{ env.BASE_IMAGE_DESCRIPTION }}

      - name: "Test: Setup BATS testing framework"
        uses: mig4/setup-bats@v1.2.0

      - name: "Test: Run smoke suite on base image"
        run: |
          set -euo pipefail
          scripts/test.sh \
            --image "${VERSION_TAG}"

      - name: "Publish: Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Publish: Push architecture-specific image"
        run: |
          set -euo pipefail
          docker push "${VERSION_TAG}"
          docker push "${LATEST_TAG}"

  build_arm64:
    name: "arm64: Build, test, and publish ${{ inputs.base }}"
    runs-on: ubuntu-24.04-arm
    needs: load_config
    env:
      PLATFORM: linux/arm64
      ARCH_SUFFIX: arm64
      BASE_ALIAS: ${{ inputs.base }}
      BASE_IMAGE_DISTRO: ${{ needs.load_config.outputs.BASE_IMAGE_DISTRO }}
      BASE_IMAGE_DESCRIPTION: ${{ needs.load_config.outputs.BASE_IMAGE_DESCRIPTION }}
      AICAGE_IMAGE_REGISTRY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_BASE_REPOSITORY: ${{ needs.load_config.outputs.AICAGE_IMAGE_BASE_REPOSITORY }}
      AICAGE_VERSION: ${{ github.ref_name }}
    outputs:
      VERSION_TAG: ${{ steps.config.outputs.VERSION_TAG }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set config
        id: config
        shell: bash
        run: |
          set -euo pipefail
          VERSION_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-${ARCH_SUFFIX}-${AICAGE_VERSION}"
          LATEST_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-${ARCH_SUFFIX}-latest"
          {
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "LATEST_TAG=${LATEST_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "LATEST_TAG=${LATEST_TAG}"
          } >> "$GITHUB_ENV"

      - name: Build (local only, leaves image on runner)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          build-args: |
            BASE_IMAGE=${{ needs.load_config.outputs.BASE_IMAGE }}
            OS_INSTALLER=${{ needs.load_config.outputs.OS_INSTALLER }}
          tags: |
            ${{ steps.config.outputs.VERSION_TAG }}
            ${{ steps.config.outputs.LATEST_TAG }}
          labels: |
            org.opencontainers.image.description=Base image for aicage (${{ env.BASE_ALIAS }})
            org.aicage.base=${{ env.BASE_ALIAS }}
            org.aicage.base.distro=${{ env.BASE_IMAGE_DISTRO }}
            org.aicage.base.description=${{ env.BASE_IMAGE_DESCRIPTION }}

      - name: "Test: Setup BATS testing framework"
        uses: mig4/setup-bats@v1.2.0

      - name: "Test: Run smoke suite on base image"
        run: |
          set -euo pipefail
          scripts/test.sh \
            --image "${VERSION_TAG}"

      - name: "Publish: Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Publish: Push architecture-specific image"
        run: |
          set -euo pipefail
          docker push "${VERSION_TAG}"
          docker push "${LATEST_TAG}"

  manifest:
    name: Publish multi-arch manifest ${{ inputs.base }}
    runs-on: ubuntu-latest
    needs: [load_config, build_amd64, build_arm64]

    env:
      BASE_ALIAS: ${{ inputs.base }}
      BASE_IMAGE_DISTRO: ${{ needs.load_config.outputs.BASE_IMAGE_DISTRO }}
      BASE_IMAGE_DESCRIPTION: ${{ needs.load_config.outputs.BASE_IMAGE_DESCRIPTION }}
      AICAGE_IMAGE_REGISTRY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_BASE_REPOSITORY: ${{ needs.load_config.outputs.AICAGE_IMAGE_BASE_REPOSITORY }}
      AICAGE_VERSION: ${{ github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Create and push multi-arch manifest"
        run: |
          set -euo pipefail
          VERSION_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-${AICAGE_VERSION}"
          LATEST_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-latest"

          docker buildx imagetools create \
            --tag "${VERSION_TAG}" \
            --tag "${LATEST_TAG}" \
            --annotation "index:org.opencontainers.image.description=Base image for aicage (${BASE_ALIAS})" \
            --annotation "index:org.opencontainers.image.source=${GITHUB_SERVER_URL}/${AICAGE_IMAGE_BASE_REPOSITORY}" \
            --annotation "index:org.aicage.base=${BASE_ALIAS}" \
            --annotation "index:org.aicage.distro=${BASE_IMAGE_DISTRO}" \
            --annotation "index:org.aicage.description=${BASE_IMAGE_DESCRIPTION}" \
            "${{ needs.build_amd64.outputs.VERSION_TAG }}" \
            "${{ needs.build_arm64.outputs.VERSION_TAG }}"

          for tag in "${VERSION_TAG}" "${LATEST_TAG}"; do
            echo "Inspect tag '${tag}':"
            docker buildx imagetools inspect "${tag}"
            echo "Inspect annotations of tag '${tag}':"
            docker buildx imagetools inspect --raw "${tag}" | jq '.annotations'
          done

            

